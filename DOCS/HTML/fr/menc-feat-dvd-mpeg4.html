<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>7.11. Créer un rip MPEG-4 ("DivX") de haute qualité à partir d'un DVD</title><link rel="stylesheet" href="default.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.49"><link rel="home" href="index.html" title="MPlayer - Le Lecteur Vidéo"><link rel="up" href="mencoder.html" title="Chapitre 7. Encodage avec MEncoder"><link rel="previous" href="custommatrices.html" title="7.10. Inter/intra matrices personnalisées"><link rel="next" href="menc-feat-telecine.html" title="7.12. Comment gérer le téléciné et le désentrelacement avec les DVDs NTSC"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">7.11. Créer un rip MPEG-4 ("DivX") de haute qualité à partir d'un DVD</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="custommatrices.html">Précédent</a> </td><th width="60%" align="center">Chapitre 7. Encodage avec MEncoder</th><td width="20%" align="right"> <a accesskey="n" href="menc-feat-telecine.html">Suivant</a></td></tr></table><hr></div><div class="sect1"><div class="titlepage"><div><h2 class="title" style="clear: both"><a name="menc-feat-dvd-mpeg4"></a>7.11. Créer un rip MPEG-4 ("DivX") de haute qualité à partir d'un DVD</h2></div></div><p>
  Une question fréquemment posée est "Comment faire le meilleur rip DVD possible ?
  Peut importe la taille du fichier, je veux simplement la meilleure qualité."
</p><p>
  Cette question est peut être un peu mal posée. Après tout, si vous ne vous
  souciez pas de la taille du fichier, pourquoi ne pas simplement copier le
  flux MPEG-2 du DVD entier ? Bien sûr, votre AVI finira par faire 5Go, mais
  si vous voulez la meilleure qualité et ne vous souciez pas de la taille,
  ceci est probablement votre meilleure option.
</p><p>
  En fait, la raison pour laquelle vous voulez convertir un DVD en MPEG-4
  est que vous tenez <span class="bold"><b>réellement</b></span> compte
  de la taille du fichier.
</p><p>
  Il est difficile de proposer une recette sur la façon de créer des rips DVD
  de très haute qualité. Il y a de nombreux facteurs à prendre en compte, et vous
  devriez comprendre ces détails, ou vous serez déçus par les résultats. Ci-dessous
  nous allons examiner quelques-uns de ces problèmes, et voir un exemple. Nous
  supposerons que vous utilisez 
  <tt>libavcodec</tt> pour encoder la vidéo, bien
  que cette exemple théorique s'applique également à d'autres codecs.
</p><p>
  L'hypothèse principale de ce guide est que vous n'avez pas de contraintes
  de taille particulière et que perdre des octets en échange d'une meilleure qualitée
  ne vous dérange pas. Bien que la plupart des informations présentées ici soient 
  utiles dans la plupart des cas, une partie peut vous poser problème si vous
  prévoyez une certaine taille, pour faire tenir une vidéo sur un CD par exemple.
</p><div class="sect2"><div class="titlepage"><div><h3 class="title"><a name="menc-feat-dvd-mpeg4-2pass"></a>7.11.1. Quantiseur constant contre 2-passes</h3></div></div><p>
  Il y a trois approches possibles pour encoder une vidéo: débit constant
  (CBR), quantiseur constant, et deux-passes (ABR, ou débit moyen). 
</p><p>
  Dans chacun de ces modes, <tt>libavcodec</tt>
  sépare les trames vidéos en macroblocs de 16x16 pixels et applique ensuite
  un quantiseur sur chaque macrobloc. Plus le quantiseur est bas, plus la
  qualité est bonne et le débit est gros. La méthode utilisée par
  <tt>libavcodec</tt> pour déterminer quel
  quantiseur utiliser varie et est très réglable (ceci est une simplification
  à l'extrème du processus, mais il est utile de comprendre le principe de base).
</p><p>
  Lorsque vous spécifiez un débit constant, <tt>libavcodec</tt> encodera la vidéo en éliminant juste assez
  de détails pour rester en dessous du débit demandé. Si vous ne vous souciez pas
  de la taille de fichier, vous pouvez utiliser le CBR et spécifier un débit
  infini (en pratique, cela signifie une valeur suffisamment grande pour ne pas
  avoir de limite, comme 10000Kbit). Sans réelle restriction de débit, en définitive
  <tt>libavcodec</tt> utilisera le plus
  bas quantiseur possible pour chaque macrobloc (tel que spécifié par
  <tt class="option">vqmin</tt>, qui vaut 2 par défaut). Si vous spécifiez un débit si
  bas que <tt>libavcodec</tt> soit forcé d'utiliser
  un quantiseur plus haut, alors vous êtes certainement en train de massacrer la 
  qualité de votre vidéo. En général, vous devriez éviter le CBR si vous vous
  souciez de la qualité.
</p><p>
  Avec un quantiseur constant <tt>libavcodec</tt> utilise le même quantiseur, spécifié par
  l'option <tt class="option">vqscale</tt>, sur chaque macrobloc. Si vous voulez un rip
  de la meilleure qualité possible, là encore en ignorant le débit, vous pouvez
  utiliser <tt class="option">vqscale=2</tt>. Cela donnera le même débit et le même
  PSNR (Peak Signal-to-Noise Ratio, rapport signal sur bruit de crête) que le CBR avec
  <tt class="option">vbitrate</tt>=infini et la valeur de <tt class="option">vqmin</tt> par 
  défaut (2).
</p><p>
  Le problème de la quantification constante est qu'elle utilise le quantiseur
  demandé même si le macrobloc n'en a pas besoin. En fait, il doit être possible
  d'utiliser un quantiseur plus haut sur un macrobloc sans sacrifier de la qualité
  visuelle. Pourquoi gaspiller des bits avec un quantiseur inutilement bas ?
</p><p>
  Avec l'encodage deux-passes, la première passe va ripper le film comme
  en CBR, mais va garder un log des propriétés de chaque trame. Ces données
  sont ensuites utilisées pendant la seconde passe de façon à choisir intelligemment
  quels quantiseurs utiliser. Lors des scènes
  d'action rapide ou celles ayant peu de détails, des quantiseurs plus haut
  seront utilisés, et durant les scènes avec peu de mouvements ou avec beaucoup
  de détails, des quantiseurs plus bas seront utilisés.
</p><p>
  Si vous utilisez <tt class="option">vqscale=2</tt>, alors vous gaspillerez des bits.
  Si vous utilisez <tt class="option">vqscale=3</tt>, vous n'aurez pas la meilleur
  qualité de rip. Supposez que vous rippez un DVD avec <tt class="option">vqscale=3</tt>, 
  et que le résultat soit 1800Kbit. Si vous faites un encodage 2-passes avec
  <tt class="option">vbitrate=1800</tt>, la vidéo produite aura une 
  <span class="bold"><b>meilleur qualité</b></span> pour le 
  <span class="bold"><b>même débit</b></span>.
</p><p>
  Maintenant que vous êtes convaincu que l'encodage 2-passes est la bonne méthode,
  la vraie question est maintenant de savoir quel débit utiliser. La réponse
  est qu'il n'y a pas de réponse unique. Idéalement, vous devriez choisir un
  débit offrant un compromis entre qualité et taille de fichier. Cela varie suivant
  la source vidéo.
</p><p>
  Un bon point de départ pour un rip de très haute qualité est environ 2000Kbit,
  plus ou moins 200Kbit. Pour les vidéos comportant beaucoup d'actions ou de détails,
  ou si vous avez de très bon yeux, vous pouvez choisir 2400 ou 2600.
  Pour certains DVDs, vous pourriez voir une différence à 1400Kbit. C'est une bonne
  idée que d'essayer sur des scènes à différents débits pour s'en rendre compte.
</p></div><div class="sect2"><div class="titlepage"><div><h3 class="title"><a name="menc-feat-dvd-mpeg4-crop"></a>7.11.2. Découpage et Redimensionnement</h3></div></div><p>
  La résolution native des DVDs est de 720x480 pour NTSC, et 720x576 pour PAL,
  mais il y a un drapeau d'aspect qui spécifie si il s'agit de plein-écran (4:3)
  ou d'écran large (16:9). La plupart (si ce n'est tous) des DVDs écran large
  ne sont pas tout à fait 16:9, ils peuvent être soit en 1.85:1, soit en 2.35:1
  (cinémascope). Cela signifie qu'il va y avoir des bandes noires qu'il va falloir
  découper.
</p><p>
  <span class="application">MPlayer</span> fournit un filtre de détection de bandes noires
  qui détermine la zone à découper (<tt class="option">-vf cropdetect</tt>).
  Puisque MPEG-4 utilise des macroblocs de 16x16, vous devez vous assurer
  que la vidéo que vous encodez est un multiple de 16, sinon la qualité sera
  dégradée, surtout en bas débit. Vous pouvez faire ceci en arrondissant la
  longueur et la largeur du rectangle de découpage au multiple de 16 le plus
  proche. Pour le découpage, vous pouvez augmenter l'offset y de la moitié
  de la différence entre l'ancienne et la nouvelle hauteur de façon à ce que
  la vidéo obtenue soit prise à partir du centre de la trame. Et à cause de
  la façon dont est faite la vidéo des DVDs, assurez-vous que l'offset soit un
  nombre pair (en fait, en règle générale, n'utilisez jamais de nombres impairs
  lorsque vous découpez et redimensionnez une vidéo). Si perdre quelques pixels
  vous incommode, vous pouvez préférer redimensionner la vidéo. Nous allons
  voir cela dans l'exemple plus bas.
</p><p>
  De plus, faites attention aux pixels "à moitié noirs" sur les
  bords.
  Assurez-vous de les découper également, ou sinon vous gaspillerez des bits
  qui seraient mieux dépensés ailleurs.
</p><p>
  Une fois tout ceci fait, vous obtiendrez probablement une vidéo dont les
  pixels n'ont pas vraiment un rapport de 1.85:1 ou 2.35:1, mais quelque chose
  d'approchant. Vous pouvez calculer le nouvel ratio d'aspect manuellement,
  mais <span class="application">MEncoder</span> offre une option pour <tt>libavcodec</tt> appelée <tt class="option">autoaspect</tt>
  qui le fera pour vous. Ne redimmensionnez pas la vidéo pour obtenir des pixels
  carrés, à moins que vous n'aimiez gaspiller votre espace disque. Le
  redimensionnement devrait être appliqué lors de la lecture, et le lecteur
  utilisera l'aspect stocké dans le fichier AVI pour déterminer la résolution 
  appropriée.
</p></div><div class="sect2"><div class="titlepage"><div><h3 class="title"><a name="menc-feat-dvd-mpeg4-audio"></a>7.11.3. Audio</h3></div></div><p>
  L'audio est un problème bien plus simple à résoudre: laissez-le juste tel-quel.
  Même les flux AC3 5.1 sont au plus en 448Kbit/s, dont chaque bit est utile.
  Vous pouvez être tenté de convertir l'audio en Ogg Vorbis de haute qualité,
  mais ne pas avoir de décodeur AC3 aujourd'hui ne veut pas dire que vous n'en
  aurez pas demain. Préparez le futur de vos rips DVDs en gardant le flux AC3.
</p></div><div class="sect2"><div class="titlepage"><div><h3 class="title"><a name="menc-feat-dvd-mpeg4-interlacing"></a>7.11.4. Interlacing and Telecine</h3></div></div><p>
  La plupart des films sont tournés en 24 fps. Puisque NTSC est en 29.97 fps,
  certains traitements doivent être appliqués pour l'adapter au débit NTSC.
  Ce procédé est appelé 3:2 pulldown, plus communément appelé téléciné (car
  le pulldown est souvent appliqué durant la phase de conversion en téléciné),
  et de façon simpliste, il fonctionne en ralentissant le film à 23.976 fps,
  et en répétant chaque quatrième trame.
</p><p>
  Aucun traitement spécifique, n'est cependant appliqué pour la vidéo des DVDs
  PAL, qui tournent à 25 fps (techniquement, PAL peut être téléciné, ce qui est
  appelé 2:2 pulldown, mais ceci n'est pas un problème en pratique). Le film
  24 fps est simplement lu en 25 fps. Le résultat est que la vidéo tourne 
  légèrement plus vite, mais à moins d'être un alien, vous ne verrez pas la 
  différence. La plupart des DVDs ont de l'audio dont le ton a été corrigé,
  donc quand elle est joué à 25 fps cela sonne correctement, même si la piste
  audio (et donc le film entier) a une durée 4% plus courte que les DVDs NTSC.
</p><p>
  Puisque la vidéo d'un DVD PAL n'a pas été altérée, vous n'avez pas à vous soucier
  du débit. La source est en 25 fps, et votre rip sera en 25 fps. Par contre,
  si vous rippez un film d'un DVD NTSC, vous pourriez avoir besoin d'appliquer
  du téléciné inverse.
</p><p>
  Pour les films tournés en 24fps, la vidéo du DVD NTSC est soit en 29.97 fps
  téléciné, soit en 24 fps progressif et prévu pour être téléciné à la volée
  par le lecteur DVD. D'un autre coté, les séries TV sont généralement
  seulement
  entrelaçées, pas télécinées. Ce n'est pas une règle absolue: certaines séries
  TV sont entrelaçées (comme Buffy contre les vampires) alors que d'autres sont
  un mélange de progressif et d'entrelaçé (comme Dark Angel, ou 24 heures
  chrono).
</p><p>
  Il est fortement recommandé de lire la section <a href="menc-feat-telecine.html" title="7.12. Comment gérer le téléciné et le désentrelacement avec les DVDs NTSC">
  Comment gérer le téléciné et le désentrelacement avec les DVDs NTSC</a>
  pour apprendre à gérer les différentes possibilités.
</p><p>
  De toute façon, si vous rippez surtout des films, vous rencontrerez soit de
  la vidéo 24 fps progressive, soit télécinée, et dans ce cas vous pouvez
  utiliser le filtre <tt class="option">pullup</tt> <tt class="option">-vf pullup,softskip</tt>.
</p></div><div class="sect2"><div class="titlepage"><div><h3 class="title"><a name="menc-feat-dvd-mpeg4-filtering"></a>7.11.5. Filtrage</h3></div></div><p>
  En général, vous devriez appliquer le moins de filtres possible de façon
  à rester proche de la source DVD originale. Le découpage des bandes noires
  est souvent nécessaire (comme décrit ci-dessus), mais pas le
  redimensionnement.
  Bien réduire la résolution soit parfois préférée à l'usage de quantiseurs
  plus élévés, nous voulons éviter ces deux choses: rappelez-vous qu'au début
  nous avions décidé de privilégier la qualité sur l'encombrement disque.
</p><p>
  De plus, n'ajustez pas le gamma, le contraste, la luminosité, etc. Ce qui
  s'affiche correctement sur votre matériel ne sera pas forcément pareil sur
  d'autres. Ces ajustements ne devraient être appliqués que lors de la lecture.
</p><p>
  Une chose que vous pouvez faire, cependant, est de passer la vidéo au travers
  d'un très léger filtre anti-bruit, tel que <tt class="option">-vf hqdn3d=2:1:2</tt>.
  De nouveau, il s'agit d'utiliser ces bits de la meilleur façon: pourquoi les
  gaspiller à encoder du bruit alors que vous pouvez en rajouter durant la
  lecture ?
  Augmenter les paramètres de <tt class="option">hqdn3d</tt> améliorera la
  compressibilité, mais si vous augmentez trop, vous risquez de dégrader
  l'image. Les valeurs suggérées ci-dessus (<tt class="option">2:1:2</tt>) sont très
  conservatrices; vous êtes libre d'expérimenter des valeurs plus grandes et
  d'observer les résultats par vous-même.
</p></div><div class="sect2"><div class="titlepage"><div><h3 class="title"><a name="menc-feat-dvd-mpeg4-example"></a>7.11.6. Exemple</h3></div></div><p>
  Donc, vous venez d'acheter votre tout nouvel exemplaire de Harry Potter et
  la Chambre des Secrets (édition panoramique, bien sûr), et vous voulez ripper
  ce DVD pour pouvoir l'ajouter à votre PC Home Cinema. C'est un
  DVD zone 1, donc en NTSC. L'exemple ci-dessous s'applique également au PAL,
  à part l'option <tt class="option">-ofps 23.976</tt> qui devient inutile (car le
  débit sortant est le même que le débit entrant), et bien sûr les dimensions
  de découpe seront différentes.
</p><p>
  Après avoir lançé <tt class="option">mplayer dvd://1</tt>, nous suivons la méthode 
  décrite dans la section <a href="menc-feat-telecine.html" title="7.12. Comment gérer le téléciné et le désentrelacement avec les DVDs NTSC">Comment gérer le 
  téléciné et le désentrelacement avec les DVDs NTSC</a> et découvrons que la
  vidéo est en 24 fps progressif, ce qui signifie que nous n'aurons pas besoin
  d'utiliser un filtre de téléciné inverse, tel que <tt class="option">pullup</tt> ou
  <tt class="option">filmdint</tt>.
</p><p>
  Ensuite, il faut déterminer le rectangle de découpage approprié, nous utilisons
  donc le filtre cropdetect:

  <pre class="screen">mplayer dvd://1 -vf cropdetect</pre>

  Assurez-vous de vous placer dans une trame parfaitement remplie (tel qu'une
  scène claire), et vous verrez sur la console de sortie de 
  <span class="application">MPlayer</span>:

  <pre class="screen">crop area: X: 0..719  Y: 57..419  (-vf crop=720:362:0:58)</pre>

  Nous relisons ensuite le film avec ce filtre pour tester sa justesse:

  <pre class="screen">mplayer dvd://1 -vf crop=720:362:0:58</pre>

  Et nous voyons que c'est parfait. Ensuite, nous nous assurons que la largeur
  et la hauteur sont des multiples de 16. La largeur est correcte, par contre
  la hauteur ne l'est pas. Comme nous sommes bon en maths, nous savons que le
  multiple de 16 le plus proche de 362 est 352.
</p><p>
  Nous pourrions simplement utiliser <tt class="option">crop=720:352:0:58</tt>, mais
  il serait plus sympatique de retirer un peu du haut et du bas pour aligner
  au centre.
  Nous rabotons la hauteur de 10 pixels, mais nous ne voulons pas augmenter
  le y-offset de 5 pixels car c'est un nombre impair et cela pourrait affecter
  la qualité. À la place, nous allons augmenter le y-offset de 4 pixels:

  <pre class="screen">mplayer dvd://1 -vf crop=720:352:0:62</pre>

  Une autre raison de raser les pixels du haut et du bas est de nous assurer
  que nous avons éliminé les éventuels pixels à moitié noirs.
  Notez que si votre vidéo est télécinée, assurez-vous que le filtre
  <tt class="option">pullup</tt> (ou tout autre filtre de téléciné inverse que vous
  décidez d'utiliser) apparaisse bien au début de la chaine de filtres, avant
  le découpage. Si la vidéo est entrelaçée, désentrelacez-la avant le
  découpage (si vous voulez garder la vidéo entrelaçée, alors assurez-vous que
  votre offset de découpage soit un multiple de 4).
</p><p>
  Si perdre ces 10 pixels vous gène vraiment, vous pouvez diminuer les 
  dimensions au plus proche multiple de 16.
  La chaine de filtre ressemblera alors à:

  <pre class="screen">-vf crop=720:362:0:58,scale=720:352</pre>

  La réduction de résolution implique qu'un certain nombre de détails sera
  perdu, bien que cela sera probablement imperceptible.
  Augmenter les dimensions donnera une moins bonne qualité (à moins que vous
  n'augmentiez le débit).
  Le découpage supprime ces pixels. C'est un compromis à faire à chaque fois.
  Par exemple, si le DVD a été fait pour la télévision, vous devriez éviter
  de redimensionner verticalement, puisque l'échantillonnage de lignes
  correspond à la façon dont a été enregistré le contenu.
</p><p>
  Après inspection, nous voyons que le film comporte pas mal d'action et un
  haut niveau de détail, nous choisissons donc un débit de 2400Kbit.
</p><p>
  Nous sommes maintenant prêts pour l'encodage 2 passes. Passe 1:

  <pre class="screen">mencoder dvd://1 -ofps 23.976 -oac copy -vf crop=720:352:0:62,hqdn3d=2:1:2 -ovc lavc \
-lavcopts vcodec=mpeg4:vbitrate=2400:v4mv:mbd=2:trell:cmp=3:subcmp=3:mbcmp=3:autoaspect:vpass=1 \
-o Harry_Potter_2.avi</pre>

  La passe 2 est identique, sauf que nous spécifions <tt class="option">vpass=2</tt>:

  <pre class="screen">mencoder dvd://1 -ofps 23.976 -oac copy -vf crop=720:352:0:62,hqdn3d=2:1:2 -ovc lavc \
-lavcopts vcodec=mpeg4:vbitrate=2400:v4mv:mbd=2:trell:cmp=3:subcmp=3:mbcmp=3:autoaspect:vpass=2 \
-o Harry_Potter_2.avi</pre>
</p><p>
  Les options <tt class="option">v4mv:mbd=2:trell</tt> vont énormément augmenter la
  qualité au détriment du temps d'encodage. Il y a peu de raisons d'enlever
  ces options quand notre but principal est la qualité. Les options
  <tt class="option">cmp=3:subcmp=3:mbcmp=3</tt> selectionnent une fonction de
  comparaison qui donne une meilleure qualité que les paramètres par défaut.
  Vous pouvez faire des expérimentations avec ce paramètre (référez-vous à la 
  page de manuel pour les valeurs possibles) car les différentes fonctions
  peuvent avoir un impact important sur la qualité suivant la source.
  Par exemple, si vous trouvez que
  <tt>libavcodec</tt> produit trop d'artefacts
  de type "blocs", vous pouvez essayer de sélectionner le NSSE expérimental en
  tant que fonction de comparaison via <tt class="option">*cmp=10</tt>.
</p><p>
  Pour ce film, le fichier AVI final fera 138 minutes et environ 3Go. Comme
  la taille n'est pas importante, c'est tout à fait acceptable. En revanche,
  si vous voulez un fichier plus petit, vous pouvez essayer un débit plus faible.
  Augmenter le débit ne sert pas à grand chose, donc même si on peut obtenir
  une nette amélioration de 1800Kbit à 2000Kbit, l'amélioration ne sera peut
  être pas visible au dessus de 2000Kbit. Vous êtes libre d'expérimenter jusqu'à 
  ce que vous soyez satisfait du résultat. 
</p><p>
  Puisque la vidéo d'origine est passée par un filtre anti-bruit, vous pouvez
  en rajouter pendant la lecture. Ceci, en conjonction avec le filtre de
  post-processing <tt class="option">spp</tt>, augmente énormément la qualité
  perçue et permet l'élimination d'artefacts de la vidéo.
  Avec l'option <tt class="option">autoq</tt> de <span class="application">MPlayer</span>,
  vous pouvez faire varier la quantité de post-traitement faite par le filtre
  spp suivant la quantité de temps processeur disponible. De plus, à ce
  moment, vous pouvez ajouter une correction gamma et/ou de couleur pour
  l'adapter à votre affichage.
  Par exemple:

  <pre class="screen">mplayer Harry_Potter_2.avi -vf spp,noise=9ah:5ah,eq2=1.2 -autoq 3</pre>

</p></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="custommatrices.html">Précédent</a> </td><td width="20%" align="center"><a accesskey="u" href="mencoder.html">Niveau supérieur</a></td><td width="40%" align="right"> <a accesskey="n" href="menc-feat-telecine.html">Suivant</a></td></tr><tr><td width="40%" align="left" valign="top">7.10. Inter/intra matrices personnalisées </td><td width="20%" align="center"><a accesskey="h" href="index.html">Sommaire</a></td><td width="40%" align="right" valign="top"> 7.12. Comment gérer le téléciné et le désentrelacement avec les DVDs NTSC</td></tr></table></div></body></html>
